{% extends "base.html" %}
{% block title %}Reservas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary fw-bold mb-0">
        <i class="bi bi-calendar-check"></i> Reservas
    </h2>
    <div>

        {# RENOVAR SELECIONADOS - só aparece se tiver permissão #}
        {% if tem_permissao("Reservas - Renovar") %}
        <button class="btn btn-warning me-2 shadow-sm" id="renovar-tudo" title="Renovar reservas selecionadas">
            <i class="bi bi-arrow-repeat"></i> Renovar Selecionados
        </button>
        {% endif %}

        {# REMOVER SELECIONADOS - só aparece se tiver permissão #}
        {% if tem_permissao("Reservas - Remover") %}
        <button class="btn btn-danger me-2 shadow-sm" id="remover-tudo" title="Remover reservas selecionadas">
            <i class="bi bi-x-circle"></i> Remover Selecionados
        </button>
        {% endif %}

        {# NOVA RESERVA - só aparece se tiver permissão de criar #}
        {% if tem_permissao("Reservas - Criar") %}
        <button class="btn btn-primary shadow" 
                data-bs-toggle="modal" 
                data-bs-target="#reservaModal"
                onclick="novaReserva()">
            <i class="bi bi-plus-circle"></i> Nova Reserva
        </button>
        {% endif %}

        {# Caso o usuário não tenha nenhuma permissão dos três botões (fica limpo) #}
        {% if not tem_permissao("Reservas - Renovar") and not tem_permissao("Reservas - Remover") and not tem_permissao("Reservas - Criar") %}
        <span class="text-muted small"></span>
        {% endif %}

    </div>
</div>

<!-- FILTROS E BUSCA -->
<div class="card card-atlantica mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-5">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" id="busca-tabela" class="form-control" 
                           placeholder="Buscar por empresa, CNPJ ou representante...">
                </div>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-lg" id="filtro-status">
                    <option value="">Todos os Status</option>
                    <option value="ATIVA">Ativas</option>
                    <option value="VENCIDA">Vencidas</option>
                    <option value="REMOVIDA">Removidas</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary btn-lg w-100" onclick="location.reload()">
                    <i class="bi bi-arrow-counterclockwise"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- TABELA DE RESERVAS -->
<div class="card card-atlantica">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle" id="tabela-reservas">
                <thead class="table-primary text-white">
                    <tr>
                        <th width="40">
                            <!-- Checkbox de seleção em massa só aparece se tiver permissão de renovar OU remover -->
                            {% if tem_permissao("Reservas - Renovar") or tem_permissao("Reservas - Remover") %}
                            <input type="checkbox" class="form-check-input select-all" title="Selecionar todos">
                            {% endif %}
                        </th>
                        <th>EMPRESA</th>
                        <th>CNPJ</th>
                        <th>REPRESENTANTE</th>
                        <th>INÍCIO</th>
                        <th>FIM</th>
                        <th>STATUS</th>
                        <th class="text-center">FILA</th>
                        <th class="text-center">AÇÕES</th>
                    </tr>
                </thead>
                <tbody>
                    {% if reservas|length == 0 %}
                    <tr>
                        <td colspan="9" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                            <h5>Nenhuma reserva encontrada</h5>
                        </td>
                    </tr>
                    {% else %}
                        {% for r in reservas %}
                        <tr data-id="{{ r.id }}"
                            class="{% if r.status == 'VENCIDA' %}table-danger
                                   {% elif r.status == 'ATIVA' %}table-success
                                   {% else %}table-secondary{% endif %}">

                            <!-- CHECKBOX INDIVIDUAL (só aparece se puder renovar ou remover) -->
                            <td>
                                {% if tem_permissao("Reservas - Renovar") or tem_permissao("Reservas - Remover") %}
                                <input type="checkbox" class="form-check-input" name="reserva_ids" value="{{ r.id }}">
                                {% endif %}
                            </td>

                            <td class="fw-bold text-uppercase">{{ r.empresa }}</td>
                            <td>{{ r.cnpj }}</td>
                            <td>{{ r.representante or '-' }}</td>
                            <td>{{ r.data_inicio.strftime('%d/%m/%Y') }}</td>
                            <td>{{ r.data_fim.strftime('%d/%m/%Y') if r.data_fim else '-' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if r.status == 'ATIVA' else 'danger' if r.status == 'VENCIDA' else 'secondary' }} px-3 py-2 fs-6">
                                    {{ r.status }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if r.fila_interesse %}
                                    {% set fila = r.fila_interesse.split(',') %}
                                    <button class="btn btn-sm btn-info rounded-pill px-3" 
                                            data-bs-toggle="modal" data-bs-target="#filaModal"
                                            onclick="mostrarFila('{{ r.fila_interesse|replace("'", "\\'") }}')">
                                        {{ fila|length }}
                                    </button>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>

                            <!-- AÇÕES TRAVADAS POR PERMISSÃO -->
                            <td class="text-center">
                                <div class="btn-group" role="group">

                                    {% if tem_permissao("Reservas - Editar") %}
                                    <button class="btn btn-sm btn-outline-primary" title="Editar"
                                            onclick="editarReserva({{ r.id }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% endif %}

                                    {% if tem_permissao("Reservas - Renovar") %}
                                    <button class="btn btn-sm btn-success" title="Renovar"
                                            onclick="renovarReserva({{ r.id }})">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                    {% endif %}

                                    {% if tem_permissao("Reservas - Remover") %}
                                    <button class="btn btn-sm btn-danger" title="Remover"
                                            onclick="removerReserva({{ r.id }})">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                    {% endif %}

                                    <!-- Se não tiver nenhuma permissão de ação -->
                                    {% if not tem_permissao("Reservas - Editar") and not tem_permissao("Reservas - Renovar") and not tem_permissao("Reservas - Remover") %}
                                    <small class="text-muted">—</small>
                                    {% endif %}

                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL NOVA / EDITAR RESERVA -->
<div class="modal fade" id="reservaModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalReservaTitle">Nova Reserva</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalReservaBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" style="width:4rem;height:4rem;"></div>
                    <p class="mt-3 text-muted">Carregando formulário...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL FILA DE INTERESSE -->
<div class="modal fade" id="filaModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h6 class="modal-title">Fila de Interesse</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="filaModalBody">
                <p class="text-muted">Carregando...</p>
            </div>
        </div>
    </div>
</div>

<script>
let modalReserva = null;

document.addEventListener('DOMContentLoaded', () => {
    modalReserva = new bootstrap.Modal(document.getElementById('reservaModal'));
    
    // ========== CONFIRMAÇÃO DE SUBSTITUIÇÃO (CORRIGIDO PARA MÚLTIPLAS) ==========
    const substituicoes = [];
    document.querySelectorAll('.flash-messages .alert').forEach(alert => {
        if (alert.textContent.includes('SUBSTITUIR') || alert.textContent.includes('CONFIRMAR_SUBSTITUICAO')) {
            substituicoes.push(alert.innerHTML);
            alert.remove();
        }
    });

    if (substituicoes.length > 0) {
        const mensagem = substituicoes.map(m => m.replace(/<[^>]*>/g, '').trim()).join('\n\n');
        if (confirm("ATENÇÃO!\n\n" + mensagem + "\n\nDeseja realmente SUBSTITUIR a(s) reserva(s) existente(s)?")) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/reserva_substituir';
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Garante que o modal limpa ao fechar
    document.getElementById('reservaModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('modalReservaBody').innerHTML = '';
        document.getElementById('modalReservaTitle').textContent = '';
    });
});

// ============= ABRIR MODAL =============
function abrirModalReserva(url, titulo) {
    const body = document.getElementById('modalReservaBody');
    const title = document.getElementById('modalReservaTitle');
    
    title.textContent = titulo;
    body.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" style="width:5rem;height:5rem;"></div><p class="mt-3 fs-5">Carregando...</p></div>';
    
    modalReserva.show();

    fetch(url)
        .then(r => r.text())
        .then(html => {
            body.innerHTML = html;
            setTimeout(inicializarFormularioReserva, 100);
        })
        .catch(() => {
            body.innerHTML = '<div class="text-center py-5 text-danger"><h5>Erro ao carregar</h5><p>Recarregue a página.</p></div>';
        });
}

function novaReserva() { abrirModalReserva('/reserva_form', 'Nova Reserva'); }
function editarReserva(id) { abrirModalReserva(`/reserva_form/${id}`, 'Editar Reserva'); }

// ============= INICIALIZAR FORMULÁRIO =============
function inicializarFormularioReserva() {
    // Data fim automática
    const inicio = document.getElementById('data_inicio');
    const fim = document.getElementById('data_fim');
    if (inicio && fim) {
        const calc = () => {
            if (inicio.value) {
                const d = new Date(inicio.value);
                d.setMonth(d.getMonth() + 6);
                fim.value = d.toISOString().split('T')[0];
            }
        };
        inicio.addEventListener('change', calc);
        calc();
    }

    // Busca de cliente (só nova reserva)
    const busca = document.getElementById('busca_empresa');
    const sugestoes = document.getElementById('sugestoes');
    if (busca && !busca.readOnly) {
        busca.focus();
        busca.addEventListener('input', function() {
            if (this.value.length < 2) {
                sugestoes.style.display = 'none';
                return;
            }
            fetch(`/api/clientes_busca?q=${encodeURIComponent(this.value)}`)
                .then(r => r.json())
                .then(data => {
                    sugestoes.innerHTML = '';
                    if (data.length === 0) {
                        sugestoes.innerHTML = '<div class="p-3 text-muted small">Nenhum cliente encontrado</div>';
                    } else {
                        data.slice(0, 10).forEach(c => {
                            const div = document.createElement('div');
                            div.className = 'px-3 py-2 border-bottom cursor-pointer hover-bg-light';
                            div.innerHTML = `<strong class="text-primary">${c.empresa}</strong><small class="text-muted d-block">${c.cnpj}</small>`;
                            div.onclick = () => {
                                document.querySelector('[name="empresa"]').value = c.empresa;
                                document.querySelector('[name="cnpj"]').value = c.cnpj;
                                document.getElementById('cliente_id').value = c.id;
                                document.getElementById('dadosCliente').style.display = 'block';
                                document.getElementById('msgInicial').style.display = 'none';
                                sugestoes.style.display = 'none';
                                busca.readOnly = true;
                            };
                            sugestoes.appendChild(div);
                        });
                    }
                    sugestoes.style.display = 'block';
                });
        });
    }

    // Fila de interesse
    const select = document.getElementById('select-fila');
    const container = document.getElementById('fila-selecionados');
    const hidden = document.getElementById('fila_interesse_input');
    if (select && container && hidden) {
        const atualizar = () => {
            hidden.value = [...container.querySelectorAll('.badge')]
                .map(b => b.textContent.trim().split(' ')[0])
                .filter(Boolean)
                .join(',');
        };
        select.onchange = () => {
            if (!select.value) return;
            if ([...container.querySelectorAll('.badge')].some(b => b.textContent.includes(select.value))) {
                select.value = ''; return;
            }
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary me-2 mb-2 fs-6';
            badge.innerHTML = `${select.value} <button type="button" class="btn-close btn-close-white ms-2" style="font-size:0.7em;"></button>`;
            container.appendChild(badge);
            select.value = '';
            atualizar();
        };
        container.addEventListener('click', e => {
            if (e.target.classList.contains('btn-close')) {
                e.target.closest('.badge').remove();
                atualizar();
            }
        });
        atualizar();
    }
}

// ============= AÇÕES (RENOVAR / REMOVER) =============
function renovarReserva(id) {
    if (confirm('Renovar esta reserva por mais 6 meses?')) {
        fetch(`/reservas/renovar/${id}`, {method: 'POST'})
            .then(r => r.json())
            .then(d => d.success && location.reload());
    }
}

function removerReserva(id) {
    if (confirm('REMOVER permanentemente esta reserva?\nNão poderá desfazer!')) {
        fetch(`/reservas/remover/${id}`, {method: 'POST'})
            .then(r => r.json())
            .then(d => d.success && location.reload());
    }
}

// Renovar / Remover em massa
document.getElementById('renovar-tudo')?.addEventListener('click', () => {
    const ids = [...document.querySelectorAll('input[name="reserva_ids"]:checked')].map(c => c.value);
    if (!ids.length) return alert('Selecione ao menos uma reserva!');
    if (confirm(`Renovar ${ids.length} reserva(s)?`)) {
        fetch('/reservas/renovar_massa', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ids})})
            .then(() => location.reload());
    }
});

document.getElementById('remover-tudo')?.addEventListener('click', () => {
    const ids = [...document.querySelectorAll('input[name="reserva_ids"]:checked')].map(c => c.value);
    if (!ids.length) return alert('Selecione ao menos uma reserva!');
    if (confirm(`REMOVER permanentemente ${ids.length} reserva(s)?\nIRREVERSÍVEL!`)) {
        fetch('/reservas/remover_massa', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ids})})
            .then(() => location.reload());
    }
});

// Busca em tempo real na tabela de reservas (CORRIGIDO)
document.getElementById('busca-tabela')?.addEventListener('input', function() {
    const termo = this.value.toLowerCase().trim();
    const tabela = document.getElementById('tabela-reservas');
    const linhas = tabela.querySelectorAll('tbody tr');

    linhas.forEach(tr => {
        // Ignora a linha de "nenhuma reserva encontrada"
        if (tr.querySelector('td[colspan="9"]')) {
            tr.style.display = linhas.length === 1 ? '' : 'none';
            return;
        }

        const texto = tr.textContent.toLowerCase();
        tr.style.display = texto.includes(termo) ? '' : 'none';
    });
});

// Filtro por status
document.getElementById('filtro-status')?.addEventListener('change', function() {
    const statusSelecionado = this.value;
    const linhas = document.querySelectorAll('#tabela-reservas tbody tr');

    linhas.forEach(tr => {
        if (tr.querySelector('td[colspan="9"]')) {
            tr.style.display = '';
            return;
        }

        const badge = tr.querySelector('.badge');
        const statusDaLinha = badge ? badge.textContent.trim() : '';

        if (!statusSelecionado || statusDaLinha === statusSelecionado) {
            tr.style.display = '';
        } else {
            tr.style.display = 'none';
        }
    });
});
</script>
{% endblock %}